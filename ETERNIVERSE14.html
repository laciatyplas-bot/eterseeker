<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>MAPA ETERNIVERSE v14.0 ‚Äî 10 Bram + 60+ KsiƒÖg</title>
  <meta name="description" content="Pe≈Çna mapa 10 Bram z wszystkimi ksiƒôgami z oryginalnego JSON + realtime sync."/>
  <meta name="theme-color" content="#D9A441"/>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

  <style>
    :root {
      --teal: #28D3C6; --gold: #D9A441; --green: #12C65B; --purple: #9B6BFF; 
      --orange: #FFB14B; --red: #FF6B6B; --pink: #FF9FF3; --blue: #5DADE2; 
      --indigo: #667eea; --gray: #888;
    }
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      background: #000 url('https://images.unsplash.com/photo-1462331940025-496dfbfc7564?ixlib=rb-4.0.3&auto=format&fit=crop&w=2112&q=80') center/cover fixed;
      color: white; font-family: 'Inter', system-ui, sans-serif; overflow: hidden; height: 100vh;
    }

    .controls { position: fixed; top: 20px; left: 20px; z-index: 1000; display: flex; gap: 12px; flex-wrap: wrap; }
    .btn { 
      background: rgba(255,255,255,0.12); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.25); 
      color: white; padding: 12px 20px; border-radius: 16px; font-weight: 600; cursor: pointer; 
      transition: all 0.3s; font-size: 14px;
    }
    .btn:hover { background: rgba(255,255,255,0.22); transform: translateY(-3px); box-shadow: 0 10px 30px rgba(0,0,0,0.4); }

    .cloud-status { 
      position: fixed; top: 70px; right: 20px; background: rgba(40,211,198,0.2); color: var(--teal); 
      padding: 10px 16px; border-radius: 12px; font-size: 13px; font-weight: 700; border: 1px solid var(--teal); 
      z-index: 900; backdrop-filter: blur(8px); display: flex; align-items: center; gap: 8px; 
    }
    .cloud-status.offline { background: rgba(255,177,75,0.2); color: var(--orange); border-color: var(--orange); }
    .cloud-status.syncing::after { content: ' ‚Üª'; animation: spin 1s linear infinite; }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    .cloud-dot { width: 10px; height: 10px; border-radius: 50%; background: var(--green); animation: pulse 2s infinite; }
    .cloud-dot.offline { background: var(--orange); animation: none; }
    @keyframes pulse { 0%,100% { opacity: 0.6; } 50% { opacity: 1; } }

    #mapCanvas { width: 100vw; height: 100vh; cursor: grab; }
    #mapCanvas:active { cursor: grabbing; }

    .info-panel {
      position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
      background: rgba(8,18,28,0.97); backdrop-filter: blur(24px);
      border: 1px solid rgba(255,255,255,0.2); border-radius: 24px; padding: 36px; 
      max-width: 700px; max-height: 85vh; overflow-y: auto;
      box-shadow: 0 30px 80px rgba(0,0,0,0.8); z-index: 2000; display: none;
    }
    .info-title { 
      font-size: 32px; font-weight: 800; margin-bottom: 12px; text-align: center; 
      background: linear-gradient(90deg, var(--gold), white); -webkit-background-clip: text; 
      -webkit-text-fill-color: transparent; 
    }
    .info-sub { font-size: 18px; color: rgba(255,255,255,0.7); margin-bottom: 32px; text-align: center; text-transform: uppercase; letter-spacing: 1px; }
    .books-list { list-style: none; }
    .book-item { padding: 16px; background: rgba(255,255,255,0.06); border-radius: 14px; margin-bottom: 14px; border-left: 4px solid var(--teal); }
    .book-title { font-weight: 700; font-size: 17px; margin-bottom: 8px; }
    .book-status { font-size: 13px; padding: 6px 12px; border-radius: 8px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
    .status-published { background: var(--green); color: #000; }
    .status-writing { background: var(--teal); color: #000; }
    .status-ready { background: var(--gold); color: #000; }
    .status-draft { background: var(--orange); color: #000; }
    .status-idea { background: var(--gray); color: white; }
    .close-info { position: absolute; top: 20px; right: 24px; font-size: 32px; cursor: pointer; color: #aaa; transition: color 0.3s; }
    .close-info:hover { color: white; }
  </style>
</head>
<body>

<div class="cloud-status" id="cloudStatus">
  <div class="cloud-dot"></div>
  <span id="cloudText">≈Åadowanie uniwersum...</span>
</div>

<div class="controls">
  <button class="btn" id="forceSync">‚òÅ Synchronizuj</button>
  <button class="btn" id="newBook">üìñ Nowa ksiƒôga</button>
  <button class="btn" id="centerMap">üéØ Wy≈õrodkuj</button>
</div>

<div class="info-panel" id="infoPanel">
  <span class="close-info" id="closeInfo">√ó</span>
  <div class="info-title" id="infoTitle">BRAMA 1 ‚Äî INTERSEEKER</div>
  <div class="info-sub" id="infoSub">Psychika ¬∑ Trauma ¬∑ Cie≈Ñ ¬∑ Archetyp</div>
  <ul class="books-list" id="booksList"></ul>
</div>

<canvas id="mapCanvas"></canvas>

<script>
  // ===== FIREBASE CONFIG - ZMIE≈É NA SWOJE DANE =====
  const firebaseConfig = {
    apiKey: "AIzaSyDxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx", 
    authDomain: "eterniverse-xxxxx.firebaseapp.com",
    databaseURL: "https://eterniverse-xxxxx-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "eterniverse-xxxxx",
    storageBucket: "eterniverse-xxxxx.appspot.com",
    messagingSenderId: "123456789",
    appId: "1:123456789:web:abcdef123456"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
  const auth = firebase.auth();
  const universeRef = db.ref('eterniverse/universe');

  // ===== PE≈ÅNE DANE 10 BRAM Z ORYGINALNEGO JSON =====
  const BRAMY_DATA = [
    { 
      id: 1, name: "BRAMA I ‚Äî INTERSEEKER", sub: "Psychika ¬∑ Cie≈Ñ ¬∑ Pamiƒôƒá ¬∑ Trauma", 
      color: "#28D3C6",
      books: [
        { title: "InterSeeker ‚Äì Atlas Wewnƒôtrzny", status: "published" },
        { title: "ShadowSeeker ‚Äì Anatomia Cienia", status: "ready" },
        { title: "MemorySeeker ‚Äì Archeologia Wspomnie≈Ñ", status: "writing" },
        { title: "B√≥lSeeker ‚Äì Anatomia Rany", status: "draft" }
      ]
    },
    { 
      id: 2, name: "BRAMA II ‚Äî CUSTOS / GENEZA", sub: "Stra≈ºnik ¬∑ Rdze≈Ñ ¬∑ PoczƒÖtek", 
      color: "#FF6B6B",
      books: [
        { title: "Geneza", status: "ready" },
        { title: "Custos: Kodeks G≈Çƒôbi", status: "writing" }
      ]
    },
    { 
      id: 3, name: "BRAMA III ‚Äî ETERSEEKER", sub: "Wola ¬∑ Pole ¬∑ Architektura", 
      color: "#D9A441",
      books: [
        { title: "EterSeeker ‚Äì Ksiƒôga Zakazana (Tom Zero)", status: "published" },
        { title: "EterSeeker ‚Äì Architektura Woli", status: "ready" },
        { title: "PoleSeeker ‚Äì Topologia Ludzkiego Pola", status: "writing" }
      ]
    },
    { 
      id: 4, name: "BRAMA IV ‚Äî ARCHETYPY / WOLA", sub: "Konstrukcja ¬∑ Role ¬∑ Przeznaczenie", 
      color: "#9B6BFF",
      books: [
        { title: "ArchetypSeeker ‚Äì System Archetyp√≥w Eteru", status: "ready" },
        { title: "WolaSeeker ‚Äì Kwant Woli", status: "draft" },
        { title: "Kronika Woli", status: "idea" }
      ]
    },
    { 
      id: 5, name: "BRAMA V ‚Äî OBFITOSEEKER", sub: "Materia ¬∑ Przep≈Çyw ¬∑ Manifestacja", 
      color: "#12C65B",
      books: [
        { title: "ObfitoSeeker ‚Äì Kod Obfito≈õci", status: "published" },
        { title: "MateriaSeeker ‚Äì Przewodnik Cia≈Ça i Przep≈Çywu", status: "ready" },
        { title: "Ksiƒôga Przep≈Çywu", status: "writing" }
      ]
    },
    { 
      id: 6, name: "BRAMA VI ‚Äî BIOSEEKER", sub: "Cia≈Ço ¬∑ Biologia ¬∑ Regulacja", 
      color: "#FFB14B",
      books: [
        { title: "BioSeeker ‚Äì Sekret Biologii Pola", status: "ready" },
        { title: "Cia≈Ço jako Interfejs Pola", status: "draft" },
        { title: "RytmSeeker ‚Äì Mechanika Ruchu ≈ªycia", status: "idea" }
      ]
    },
    { 
      id: 7, name: "BRAMA VII ‚Äî SPLƒÑTANIE / AI", sub: "Obserwator ¬∑ Meta-to≈ºsamo≈õƒá ¬∑ Technologia", 
      color: "#5DADE2",
      books: [
        { title: "SplatanieSeeker ‚Äì Protok√≥≈Ç Obserwatora", status: "writing" },
        { title: "InterfejsSeeker ‚Äì Interfejs ≈öwiadomo≈õci", status: "ready" },
        { title: "Protok√≥≈Ç SplƒÖtania (wersja meta)", status: "draft" }
      ]
    },
    { 
      id: 8, name: "BRAMA VIII ‚Äî TRAJEKTORIE", sub: "Kod ≈ªycia ¬∑ Linie Czasu ¬∑ Fizyka Duszy", 
      color: "#FF9FF3",
      books: [
        { title: "TrajektoriaSeeker ‚Äì Mapa Linii ≈ªycia", status: "published" },
        { title: "QuantumSeeker ‚Äì Fizyka Duszy", status: "ready" },
        { title: "CzasSeeker ‚Äì Fizyka Linii Czasu", status: "writing" }
      ]
    },
    { 
      id: 9, name: "BRAMA IX ‚Äî ETERNIONY / KOLEKTYW", sub: "Wƒôz≈Çy Pola ¬∑ Wsp√≥lnota ¬∑ Misja", 
      color: "#667eea",
      books: [
        { title: "Eteriony ‚Äì Tom I", status: "ready" },
        { title: "Eteriony ‚Äì Tom II", status: "draft" },
        { title: "Mapa Uniwersum Eteru", status: "idea" }
      ]
    },
    { 
      id: 10, name: "BRAMA X ‚Äî ETERUNIVERSE", sub: "Integracja ¬∑ Jedno≈õƒá ¬∑ Architekt", 
      color: "#D9A441",
      books: [
        { title: "Architekt Eteru ‚Äî Manifest Tw√≥rcy", status: "writing" },
        { title: "Mapa Trajektorii ≈ªycia (rozszerzona)", status: "ready" }
      ]
    }
  ];

  // Stan aplikacji
  let mapData = {
    bramy: BRAMY_DATA.map(brama => ({ ...brama, x: 0, y: 0 })),
    timestamp: Date.now(),
    version: 14.0
  };

  let isOnline = navigator.onLine;
  let syncPending = false;
  let currentUser = null;
  let isDragging = false;
  let lastX, lastY;
  let scale = 0.8, offsetX = 0, offsetY = 0;

  // Canvas setup
  const canvas = document.getElementById('mapCanvas');
  const ctx = canvas.getContext('2d');
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;

  // ===== FUNKCJE POMOCNICZE =====
  const updateCloudStatus = (text, status = 'connecting') => {
    const el = document.getElementById('cloudText');
    const dot = document.querySelector('.cloud-dot');
    const container = document.getElementById('cloudStatus');
    el.textContent = text;
    container.className = `cloud-status ${status}`;
    dot.className = `cloud-dot ${status === 'offline' ? 'offline' : ''}`;
    if (status === 'syncing') container.classList.add('syncing');
    else container.classList.remove('syncing');
  };

  const getStatusClass = (status) => {
    const classes = { published: 'published', ready: 'ready', writing: 'writing', draft: 'draft', idea: 'idea' };
    return classes[status] || 'idea';
  };

  // ===== INICJALIZACJA POZYCJI =====
  const initPositions = () => {
    const radius = 850;
    mapData.bramy.forEach((brama, i) => {
      const angle = (i / mapData.bramy.length) * Math.PI * 2 - Math.PI / 2;
      brama.x = Math.cos(angle) * radius;
      brama.y = Math.sin(angle) * radius;
    });
  };

  // ===== RYSOWANIE MAPY =====
  const renderMap = () => {
    ctx.fillStyle = 'rgba(0,0,0,0.08)';
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    ctx.save();
    ctx.translate(canvas.width/2 + offsetX, canvas.height/2 + offsetY);
    ctx.scale(scale, scale);

    // Po≈ÇƒÖczenia miƒôdzy bramami
    ctx.strokeStyle = 'rgba(40,211,198,0.15)';
    ctx.lineWidth = 1.5 / scale;
    for (let i = 0; i < mapData.bramy.length; i++) {
      for (let j = i+1; j < mapData.bramy.length; j++) {
        const b1 = mapData.bramy[i], b2 = mapData.bramy[j];
        ctx.beginPath();
        ctx.moveTo(b1.x, b1.y);
        ctx.lineTo(b2.x, b2.y);
        ctx.stroke();
      }
    }

    // Bramy
    mapData.bramy.forEach(brama => {
      const pulse = Math.sin(Date.now() / 800 + brama.id) * 0.2 + 1.3;
      const size = 40 * pulse;

      const grad = ctx.createRadialGradient(brama.x, brama.y, 0, brama.x, brama.y, size * 2);
      grad.addColorStop(0, brama.color);
      grad.addColorStop(0.4, brama.color + 'cc');
      grad.addColorStop(1, 'transparent');
      ctx.fillStyle = grad;
      ctx.beginPath();
      ctx.arc(brama.x, brama.y, size * 2, 0, Math.PI * 2);
      ctx.fill();

      // Ksiƒôgi (orbity)
      brama.books.forEach((book, i) => {
        const angle = (i / brama.books.length) * Math.PI * 2 + Date.now() / 5000;
        const dist = 160 + Math.sin(Date.now() / 1000 + i) * 20;
        const bx = brama.x + Math.cos(angle) * dist;
        const by = brama.y + Math.sin(angle) * dist;

        ctx.fillStyle = book.color || '#ffffff';
        ctx.beginPath();
        ctx.arc(bx, by, 10, 0, Math.PI * 2);
        ctx.fill();
      });
    });

    ctx.restore();
    requestAnimationFrame(renderMap);
  };

  // ===== SYNCHRONIZACJA FIREBASE =====
  const pushToCloud = async () => {
    if (!isOnline || !currentUser) return;
    updateCloudStatus('Synchronizacja...', 'syncing');
    try {
      await universeRef.set({
        map_data: mapData,
        meta: {
          version: 14.0,
          last_updated: firebase.database.ServerValue.TIMESTAMP,
          device: navigator.userAgent.substring(0,50),
          userId: currentUser.uid
        }
      });
      updateCloudStatus('Zsynchronizowano', 'online');
    } catch (err) {
      console.error('B≈ÇƒÖd sync:', err);
      updateCloudStatus('B≈ÇƒÖd synchronizacji', 'offline');
    }
  };

  const pullFromCloud = async () => {
    try {
      const snapshot = await universeRef.once('value');
      if (snapshot.exists()) {
        const data = snapshot.val();
        mapData = data.map_data || mapData;
        renderMap();
        updateCloudStatus('Zsynchronizowano z chmury', 'online');
      }
    } catch (err) {
      console.error('B≈ÇƒÖd pull:', err);
    }
  };

  universeRef.on('value', (snapshot) => {
    if (!snapshot.exists() || !isOnline) return;
    const data = snapshot.val();
    if (data.map_data) {
      mapData = data.map_data;
      renderMap();
    }
  });

  const saveLocal = () => {
    localStorage.setItem('eterniverse_map_v14', JSON.stringify(mapData));
    if (isOnline) pushToCloud();
  };

  // ===== INTERAKCJE =====
  canvas.addEventListener('mousedown', (e) => {
    isDragging = true;
    lastX = e.clientX;
    lastY = e.clientY;
    canvas.style.cursor = 'grabbing';
  });

  canvas.addEventListener('mousemove', (e) => {
    if (!isDragging) return;
    const deltaX = (e.clientX - lastX) / scale;
    const deltaY = (e.clientY - lastY) / scale;
    offsetX += deltaX;
    offsetY += deltaY;
    lastX = e.clientX;
    lastY = e.clientY;
  });

  canvas.addEventListener('mouseup', () => {
    isDragging = false;
    canvas.style.cursor = 'grab';
  });

  canvas.addEventListener('wheel', (e) => {
    e.preventDefault();
    const zoom = e.deltaY > 0 ? 0.9 : 1.1;
    scale *= zoom;
    scale = Math.max(0.3, Math.min(scale, 3));
  });

  canvas.addEventListener('click', (e) => {
    if (isDragging) return;
    const rect = canvas.getBoundingClientRect();
    const mx = (e.clientX - rect.left - canvas.width/2 - offsetX) / scale;
    const my = (e.clientY - rect.top - canvas.height/2 - offsetY) / scale;

    const clicked = mapData.bramy.find(b => Math.hypot(b.x - mx, b.y - my) < 60);
    if (clicked) {
      document.getElementById('infoTitle').textContent = clicked.name;
      document.getElementById('infoSub').textContent = clicked.sub;
      const list = document.getElementById('booksList');
      list.innerHTML = clicked.books.length ? '' : '<li style="text-align:center; color:#888; padding:20px;">Brak ksiƒÖg (jeszcze)</li>';
      
      clicked.books.forEach(book => {
        const li = document.createElement('li');
        li.className = 'book-item';
        li.innerHTML = `
          <div class="book-title">${book.title}</div>
          <span class="book-status status-${getStatusClass(book.status)}">${book.status || 'idea'}</span>
        `;
        list.appendChild(li);
      });
      document.getElementById('infoPanel').style.display = 'block';
    }
  });

  // ===== PRZYCISKI =====
  document.getElementById('closeInfo').onclick = () => {
    document.getElementById('infoPanel').style.display = 'none';
  };

  document.getElementById('centerMap').onclick = () => {
    scale = 0.8; offsetX = 0; offsetY = 0;
  };

  document.getElementById('newBook').onclick = () => {
    const title = prompt('Tytu≈Ç nowej ksiƒôgi:');
    if (!title) return;
    const bramaId = prompt('Numer Bramy (1-10):');
    const brama = mapData.bramy.find(b => b.id == bramaId);
    if (brama) {
      brama.books.push({ title, status: 'idea', color: '#ffffff' });
      saveLocal();
      renderMap();
    }
  };

  document.getElementById('forceSync').onclick = async () => {
    await pullFromCloud();
    await pushToCloud();
  };

  // ===== OBS≈ÅUGA PO≈ÅƒÑCZENIA =====
  window.addEventListener('online', () => {
    isOnline = true;
    updateCloudStatus('Online', 'online');
    pullFromCloud();
  });

  window.addEventListener('offline', () => {
    isOnline = false;
    updateCloudStatus('Offline ‚Äì tryb lokalny', 'offline');
  });

  // ===== INICJALIZACJA =====
  window.addEventListener('DOMContentLoaded', async () => {
    // ≈Åaduj lokalne dane jako backup
    const localData = localStorage.getItem('eterniverse_map_v14');
    if (localData) mapData = JSON.parse(localData);

    // Firebase Auth
    try {
      await auth.signInAnonymously();
      auth.onAuthStateChanged((user) => {
        currentUser = user;
        if (user && isOnline) pullFromCloud();
      });
    } catch (err) {
      console.error('Auth error:', err);
    }

    initPositions();
    renderMap();
    
    if (isOnline) updateCloudStatus('Online', 'online');
    else updateCloudStatus('Offline ‚Äì tryb lokalny', 'offline');

    canvas.style.cursor = 'grab';
  });

  window.addEventListener('resize', () => {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
  });
</script>
</body>
</html>